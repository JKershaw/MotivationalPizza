pkill node
set -e

export MONGO_CONNECTION_STRING=mongodb://localhost/motivational-pizza

echo "Dropping database"
mongo "motivational-pizza" --eval "db.dropDatabase()"


if [ $# -lt 0  ]; then
	echo "Running JSHint"
	jshint ./tests/integration ./tests/unit
fi

echo "Unit Tests"
#mocha tests/unit/ --ui qunit --reporter nyan --timeout 5000
echo "Unit tests complete"

echo "QUnit Tests"
for D in tests/qunit/*; do
    if [ -d "${D}" ]; then
			DIR="$D/*.html"
			echo "testing in $DIR"
			#phantomjs tests/qunit/runner.js $DIR
	fi
done
echo "QUnit tests complete"


echo "Integration Tests"
foreman start &
sleep 1

for D in tests/integration/*; do
		TESTFILE="$D"
		echo "Running test $TESTFILE"
		echo "Dropping database"
		mongo "motivational-pizza" --eval "db.dropDatabase()"
		mocha $TESTFILE --recursive --ui tdd --reporter nyan --timeout 10000
done

echo "Integration tests complete"

pkill node

echo "All tests passed!"

if [ $# -gt 0  ]; then
	MESSAGE="$@"
	echo "Committing with message '$MESSAGE'"
	git add -A
	git commit -am "$MESSAGE"
	echo "Git Committed"
	git push
else
  echo "No commit message, no commit"
fi